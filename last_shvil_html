<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¤×ª ×©×‘×™×œ ×”×‘×§×¢×”</title>

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Turf for lengths/bounds -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <style>
    :root{
      --bg: rgba(255,255,255,0.92);
      --border: rgba(0,0,0,0.10);
      --shadow: 0 14px 40px rgba(0,0,0,0.18);
      --text: #0b1f2a;
      --muted: rgba(11,31,42,0.65);
      --accent: #2563eb;
      --danger: #b91c1c;
      --radius: 14px;
    }

    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; color: var(--text); }

    #map { position: fixed; inset: 0; }

    .panel {
      position: absolute;
      top: 14px;
      right: 14px;
      width: min(360px, calc(100% - 28px));
      max-height: calc(100% - 28px);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      z-index: 2;
      backdrop-filter: blur(6px);
    }

    .panelHeader {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 12px 12px 10px 12px;
      border-bottom: 1px solid var(--border);
    }

    .titleWrap { display: grid; gap: 2px; }
    .title { font-weight: 800; font-size: 14px; }
    .subtitle { font-size: 12px; color: var(--muted); }

    .headerBtns { display: flex; gap: 8px; align-items: center; }
    .iconBtn {
      border: 1px solid var(--border);
      background: white;
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
    }
    .iconBtn:hover { background: #f3f4f6; }

    .panelBody {
      padding: 12px;
      overflow: auto;
      max-height: calc(100vh - 140px);
    }

    .section { margin-bottom: 14px; }
    .sectionTitle {
      font-weight: 900;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .statRow { display: flex; gap: 10px; flex-wrap: wrap; }
    .pill {
      background: white;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 700;
    }

    .row { display: flex; gap: 8px; align-items: center; }

    .input, .select {
      width: 100%;
      border: 1px solid var(--border);
      background: white;
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 13px;
      outline: none;
    }
    .input:focus, .select:focus { border-color: rgba(37,99,235,0.45); box-shadow: 0 0 0 3px rgba(37,99,235,0.12); }

    .segList { display: grid; gap: 8px; }
    .segItem {
      display: grid;
      grid-template-columns: 12px 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: white;
      cursor: pointer;
    }
    .segItem:hover { background: #f9fafb; }
    .segItem.active { outline: 2px solid rgba(37,99,235,0.35); border-color: rgba(37,99,235,0.25); }
    .swatch { width: 12px; height: 12px; border-radius: 4px; }
    .segName { font-weight: 900; font-size: 13px; }
    .segMeta { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .segRight { text-align: left; font-weight: 900; font-size: 12px; color: var(--muted); }

    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .btn {
      border: 1px solid var(--border);
      background: white;
      border-radius: 12px;
      padding: 10px 10px;
      cursor: pointer;
      font-weight: 900;
      font-size: 12px;
      text-decoration: none;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
    }
    .btn:hover { background: #f3f4f6; }
    .btn.primary { background: rgba(37,99,235,0.10); border-color: rgba(37,99,235,0.25); }
    .btn.primary:hover { background: rgba(37,99,235,0.14); }
    .btn.danger { background: rgba(185,28,28,0.10); border-color: rgba(185,28,28,0.22); }
    .btn.danger:hover { background: rgba(185,28,28,0.14); }

    .hint { font-size: 11px; color: var(--muted); line-height: 1.4; }
    .divider { height: 1px; background: var(--border); margin: 10px 0; }

    .toast {
      position: absolute;
      left: 14px;
      bottom: 14px;
      z-index: 3;
      background: rgba(17,24,39,0.92);
      color: white;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      box-shadow: var(--shadow);
      max-width: min(520px, calc(100% - 28px));
      display: none;
    }
    .toast.show { display: block; }

    .loader {
      position: absolute;
      inset: 0;
      z-index: 4;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(3px);
    }
    .loaderCard {
      background: white;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 14px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 6px;
      text-align: center;
      max-width: 360px;
    }
    .spinner {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,0.12);
      border-top-color: rgba(37,99,235,0.8);
      margin: 0 auto 4px;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 720px) {
      .panel {
        top: auto;
        bottom: 14px;
        right: 14px;
        left: 14px;
        width: auto;
        max-height: 55vh;
      }
      .panelBody { max-height: calc(55vh - 70px); }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel" id="panel">
    <div class="panelHeader">
      <div class="titleWrap">
        <div class="title">×©×‘×™×œ ×”×‘×§×¢×” â€” ××¤×” ××™× ×˜×¨××§×˜×™×‘×™×ª</div>
        <div class="subtitle" id="subtitle">×˜×•×¢×Ÿâ€¦</div>
      </div>

      <div class="headerBtns">
        <button class="iconBtn" id="togglePanel" title="×”×¦×’/×”×¡×ª×¨">â˜°</button>
      </div>
    </div>

    <div class="panelBody" id="panelBody">
      <div class="section">
        <div class="sectionTitle"><span>×¡×˜×˜×™×¡×˜×™×§×•×ª</span></div>
        <div class="statRow">
          <div class="pill" id="totalLenPill">×¡×”×´×›: â€”</div>
          <div class="pill" id="selLenPill">××§×˜×¢: â€”</div>
          <div class="pill" id="poiCountPill">× ×§×³: â€”</div>
        </div>
        <div class="hint" style="margin-top:8px;">
          ×˜×™×¤: ×‘××—×©×‘ â€” ×”×©×ª××©×• ×‘Ö¾Ctrl/âŒ˜ + ×’×œ×™×œ×” ×›×“×™ ×œ×–×•× ×‘×œ×™ â€œ×œ×—×˜×•×£â€ ××ª ×”×“×£.
        </div>
      </div>

      <div class="divider"></div>

      <div class="section">
        <div class="sectionTitle">
          <span>×¡×™× ×•×Ÿ × ×§×•×“×•×ª ×¢× ×™×™×Ÿ</span>
          <button class="iconBtn" id="clearFilters" title="× ×§×” ×¡×™× ×•×Ÿ">× ×§×”</button>
        </div>

        <div class="row" style="margin-bottom:8px;">
          <select class="select" id="poiType">
            <option value="__all__">×›×œ ×”×¡×•×’×™×</option>
          </select>
        </div>

        <div class="row">
          <input class="input" id="poiSearch" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× × ×§×•×“×”â€¦" />
        </div>

        <div class="hint" style="margin-top:8px;">
          ×œ×—×™×¦×” ×¢×œ × ×§×•×“×” ×‘××¤×” ×ª×¤×ª×— ×ª×™××•×¨. ×”×—×™×¤×•×© ××¡× ×Ÿ ×œ×¤×™ <b>name</b>.
        </div>
      </div>

      <div class="divider"></div>

      <div class="section">
        <div class="sectionTitle">
          <span>××§×˜×¢×™×</span>
          <span class="hint">×œ×—×™×¦×” = ×–×•× ×œ××§×˜×¢</span>
        </div>
        <div class="segList" id="segList"></div>
      </div>

      <div class="divider"></div>

      <div class="section">
        <div class="sectionTitle"><span>×¤×¢×•×œ×•×ª</span></div>
        <div class="actions">
          <button class="btn primary" id="fitAllBtn">ğŸ“ ×”×¦×’ ××ª ×›×œ ×”×©×‘×™×œ</button>
          <button class="btn" id="locateBtn">ğŸ§­ ×”××™×§×•× ×©×œ×™</button>
          <a class="btn" id="downloadGpxBtn" href="./data/trail.gpx" download style="display:none;">â¬‡ï¸ ×”×•×¨×“×ª GPX</a>
          <button class="btn danger" id="resetBtn">â†©ï¸ ××™×¤×•×¡</button>
        </div>
        <div class="hint" style="margin-top:8px;">
          × ×™×•×•×˜ ×‘×©×˜×—: ×”×›×™ ×˜×•×‘ ×œ×¤×ª×•×— ××ª ×”Ö¾GPX ×‘××¤×œ×™×§×¦×™×™×ª × ×™×•×•×˜ (×œ××©×œ AllTrails/Wikiloc) ×›×“×™ ×œ×¢×‘×•×“ ×’× Offline.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="loader" id="loader">
    <div class="loaderCard">
      <div class="spinner"></div>
      <div style="font-weight:900;">×˜×•×¢×Ÿ ××ª ××¤×ª ×©×‘×™×œ ×”×‘×§×¢×”â€¦</div>
      <div style="font-size:12px; color: rgba(0,0,0,0.65);">×¢×•×“ ×¨×’×¢ ×•×–×” ×‘×.</div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    mapboxgl.accessToken = "pk.eyJ1IjoieW9uaWxlMSIsImEiOiJjbWpnN29ub24wdjlhM2ZzZHF3Y245ZXI2In0.RDRLwEtomjDyCyXhycWtSQ"; // <-- ×”×“×‘×§ ×›××Ÿ token ×¦×™×‘×•×¨×™ (pk...)

    const DATA_URL = "./data/trail.geojson";
    const GPX_URL  = "./data/trail.gpx";

    // Segment colors (1..n) â€“ adjust freely
    const SEG_COLORS = {
      1: "#1f77b4",
      2: "#ff7f0e",
      3: "#2ca02c",
      4: "#d62728",
      5: "#9467bd",
      6: "#8c564b",
      7: "#e377c2"
    };
    const FALLBACK_COLOR = "#17becf";

    // =========================
    // Helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function showToast(msg, ms = 4500) {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      window.clearTimeout(showToast._to);
      showToast._to = window.setTimeout(() => t.classList.remove("show"), ms);
    }

    function fmtKm(km) {
      if (!isFinite(km)) return "â€”";
      return (Math.round(km * 10) / 10).toFixed(1) + " ×§×´×";
    }

    function safeStr(v) { return (v ?? "").toString().trim(); }
    function segColor(seg) { return SEG_COLORS[seg] || FALLBACK_COLOR; }

    async function headOk(url) {
      try {
        const res = await fetch(url, { method: "HEAD", cache: "no-store" });
        return res.ok;
      } catch { return false; }
    }

    function setLoading(isLoading) {
      $("loader").style.display = isLoading ? "grid" : "none";
    }

    function updateSubtitle(text) {
      $("subtitle").textContent = text;
    }

    function fitBounds(bbox, padding = 50) {
      map.fitBounds([[bbox[0], bbox[1]],[bbox[2], bbox[3]]], { padding, duration: 650 });
    }

    // Promise that resolves when the map style is loaded (robust against race conditions)
    function waitForMapLoaded(mapInstance) {
      return new Promise((resolve) => {
        if (mapInstance.loaded()) return resolve();
        mapInstance.once("load", () => resolve());
      });
    }

    // Promise wrapper with timeout (prevents "spinner forever")
    async function withTimeout(promise, ms, label) {
      let to;
      const timeout = new Promise((_, reject) => {
        to = setTimeout(() => reject(new Error(`Timeout: ${label}`)), ms);
      });
      try {
        return await Promise.race([promise, timeout]);
      } finally {
        clearTimeout(to);
      }
    }

    // =========================
    // Map init
    // =========================
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/outdoors-v12",
      center: [35.5, 32.2],
      zoom: 8,
      cooperativeGestures: true
    });

    map.addControl(new mapboxgl.NavigationControl(), "top-left");
    map.addControl(new mapboxgl.FullscreenControl(), "top-left");

    const geolocate = new mapboxgl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true,
      showUserHeading: true
    });
    map.addControl(geolocate, "top-left");

    // =========================
    // State
    // =========================
    let trailData = null;
    let segmentsIndex = [];   // [{segment, lengthKm, bbox}]
    let selectedSegment = null;
    let wholeBbox = null;

    // =========================
    // Build indices + UI
    // =========================
    function computeIndexes(geojson) {
      const lineFeatures = geojson.features.filter(f => f.geometry?.type === "LineString");
      const pointFeatures = geojson.features.filter(f => f.geometry?.type === "Point");

      let totalKm = 0;
      const perSeg = new Map();
      let allB = null;

      for (const lf of lineFeatures) {
        const seg = Number(lf.properties?.segment ?? 0) || 0;
        const lenKm = turf.length(lf, { units: "kilometers" });
        totalKm += lenKm;

        if (!perSeg.has(seg)) perSeg.set(seg, { segment: seg, lengthKm: 0, bbox: null });
        const entry = perSeg.get(seg);
        entry.lengthKm += lenKm;

        const bb = turf.bbox(lf);
        if (!entry.bbox) entry.bbox = bb;
        else entry.bbox = [
          Math.min(entry.bbox[0], bb[0]),
          Math.min(entry.bbox[1], bb[1]),
          Math.max(entry.bbox[2], bb[2]),
          Math.max(entry.bbox[3], bb[3]),
        ];

        if (!allB) allB = bb;
        else allB = [
          Math.min(allB[0], bb[0]),
          Math.min(allB[1], bb[1]),
          Math.max(allB[2], bb[2]),
          Math.max(allB[3], bb[3]),
        ];
      }

      const segArr = [...perSeg.values()].filter(x => x.segment !== 0).sort((a,b)=>a.segment-b.segment);
      return { totalKm, segArr, allBbox: allB, pointCount: pointFeatures.length };
    }

    function buildSegList() {
      const segListEl = $("segList");
      segListEl.innerHTML = "";
      segmentsIndex.forEach(s => {
        const div = document.createElement("div");
        div.className = "segItem";
        div.dataset.segment = s.segment;

        const sw = document.createElement("div");
        sw.className = "swatch";
        sw.style.background = segColor(s.segment);

        const mid = document.createElement("div");
        const name = document.createElement("div");
        name.className = "segName";
        name.textContent = `××§×˜×¢ ${s.segment}`;
        const meta = document.createElement("div");
        meta.className = "segMeta";
        meta.textContent = `××•×¨×š: ${fmtKm(s.lengthKm)}`;
        mid.appendChild(name); mid.appendChild(meta);

        const right = document.createElement("div");
        right.className = "segRight";
        right.textContent = "×–×•×";

        div.appendChild(sw);
        div.appendChild(mid);
        div.appendChild(right);

        div.addEventListener("click", () => selectSegment(s.segment, true));
        segListEl.appendChild(div);
      });
    }

    function setActiveSegUI(seg) {
      [...$("segList").querySelectorAll(".segItem")].forEach(el => {
        el.classList.toggle("active", Number(el.dataset.segment) === Number(seg));
      });
    }

    function clearSegmentSelection() {
      selectedSegment = null;
      setActiveSegUI(null);
      if (map.getLayer("trail-base")) map.setPaintProperty("trail-base", "line-opacity", 0.9);
      if (map.getLayer("trail-highlight")) {
        map.setFilter("trail-highlight", ["all", ["==", ["geometry-type"], "LineString"], ["==", ["get", "segment"], -9999]]);
      }
      $("selLenPill").textContent = "××§×˜×¢: â€”";
      updateSubtitle("××•×¦×’ ×›×œ ×”×©×‘×™×œ.");
    }

    function selectSegment(seg, zoom) {
      selectedSegment = seg;
      setActiveSegUI(seg);

      if (map.getLayer("trail-highlight")) {
        map.setFilter("trail-highlight", ["all",
          ["==", ["geometry-type"], "LineString"],
          ["==", ["get", "segment"], Number(seg)]
        ]);
      }
      if (map.getLayer("trail-base")) map.setPaintProperty("trail-base", "line-opacity", 0.28);

      const entry = segmentsIndex.find(s => Number(s.segment) === Number(seg));
      $("selLenPill").textContent = `××§×˜×¢ ${seg}: ${fmtKm(entry?.lengthKm ?? NaN)}`;

      if (zoom && entry?.bbox) fitBounds(entry.bbox, 60);
      updateSubtitle(`× ×‘×—×¨ ××§×˜×¢ ${seg}.`);
    }

    function applyPoiFilters() {
      if (!map.getLayer("poi-layer")) return;

      const typeVal = $("poiType").value;
      const q = safeStr($("poiSearch").value).toLowerCase();

      const filters = ["all", ["==", ["geometry-type"], "Point"]];

      if (typeVal && typeVal !== "__all__") filters.push(["==", ["get", "type"], typeVal]);

      if (q) {
        filters.push([">=", ["index-of", q, ["downcase", ["coalesce", ["get", "name"], ""]]], 0]);
      }

      map.setFilter("poi-layer", filters);
    }

    // =========================
    // Layer initialization (idempotent)
    // =========================
    function initLayersOnce() {
      // Prevent double initialization (fundamental fix)
      if (map.getSource("trail-src")) return;

      map.addSource("trail-src", { type: "geojson", data: trailData });

      map.addLayer({
        id: "trail-base",
        type: "line",
        source: "trail-src",
        filter: ["==", ["geometry-type"], "LineString"],
        layout: { "line-join": "round", "line-cap": "round" },
        paint: {
          "line-width": 4,
          "line-opacity": 0.9,
          "line-color": [
            "case",
            ["has", "segment"],
            [
              "match",
              ["get", "segment"],
              1, segColor(1),
              2, segColor(2),
              3, segColor(3),
              4, segColor(4),
              5, segColor(5),
              6, segColor(6),
              7, segColor(7),
              FALLBACK_COLOR
            ],
            FALLBACK_COLOR
          ]
        }
      });

      map.addLayer({
        id: "trail-highlight",
        type: "line",
        source: "trail-src",
        filter: ["all", ["==", ["geometry-type"], "LineString"], ["==", ["get", "segment"], -9999]],
        layout: { "line-join": "round", "line-cap": "round" },
        paint: {
          "line-width": 7,
          "line-opacity": 0.95,
          "line-color": [
            "match",
            ["get", "segment"],
            1, segColor(1),
            2, segColor(2),
            3, segColor(3),
            4, segColor(4),
            5, segColor(5),
            6, segColor(6),
            7, segColor(7),
            FALLBACK_COLOR
          ]
        }
      });

      map.addLayer({
        id: "poi-layer",
        type: "circle",
        source: "trail-src",
        filter: ["==", ["geometry-type"], "Point"],
        paint: {
          "circle-radius": 6,
          "circle-color": "#111827",
          "circle-stroke-width": 2,
          "circle-stroke-color": "#ffffff"
        }
      });

      map.on("mouseenter", "poi-layer", () => map.getCanvas().style.cursor = "pointer");
      map.on("mouseleave", "poi-layer", () => map.getCanvas().style.cursor = "");

      map.on("click", "poi-layer", (e) => {
        const f = e.features && e.features[0];
        if (!f) return;

        const p = f.properties || {};
        const name = safeStr(p.name) || "× ×§×•×“×ª ×¢× ×™×™×Ÿ";
        const type = safeStr(p.type);
        const desc = safeStr(p.desc).replace(/\n/g, "<br/>");

        const html = `
          <div style="font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; min-width: 220px;">
            <div style="font-weight:900; margin-bottom:4px;">${name}</div>
            ${type ? `<div style="font-size:12px; opacity:0.8; margin-bottom:6px;">${type}</div>` : ""}
            ${desc ? `<div style="font-size:12px; opacity:0.9;">${desc}</div>` : `<div style="font-size:12px; opacity:0.7;">××™×Ÿ ×ª×™××•×¨.</div>`}
          </div>
        `;

        new mapboxgl.Popup({ closeButton: true, maxWidth: "320px" })
          .setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(map);
      });

      // Click on line selects segment
      map.on("click", "trail-base", (e) => {
        const f = e.features && e.features[0];
        const seg = f?.properties?.segment;
        if (seg != null) selectSegment(seg, true);
      });
    }

    // =========================
    // Main boot (fundamental, race-free)
    // =========================
    async function boot() {
      setLoading(true);
      updateSubtitle("×˜×•×¢×Ÿ × ×ª×•× ×™× ×•××¤×”â€¦");

      // Show GPX download if exists
      const gpxOk = await headOk(GPX_URL);
      const dlBtn = $("downloadGpxBtn");
      if (gpxOk) { dlBtn.style.display = "inline-flex"; dlBtn.href = GPX_URL; }
      else dlBtn.style.display = "none";

      // Load data + map concurrently, and only then init layers
      const dataPromise = (async () => {
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`GeoJSON HTTP ${res.status}`);
        return await res.json();
      })();

      const mapPromise = waitForMapLoaded(map);

      try {
        // 15s timeout prevents spinner forever in real-world bad states
        const [geojson] = await withTimeout(Promise.all([dataPromise, mapPromise]), 15000, "load map + geojson");

        trailData = geojson;

        // Build UI indices
        const { totalKm, segArr, allBbox, pointCount } = computeIndexes(trailData);
        segmentsIndex = segArr;
        wholeBbox = allBbox;

        $("totalLenPill").textContent = `×¡×”×´×›: ${fmtKm(totalKm)}`;
        $("poiCountPill").textContent = `× ×§×³: ${pointCount}`;
        $("selLenPill").textContent = "××§×˜×¢: â€”";

        buildSegList();

        // POI type dropdown
        const types = Array.from(new Set(
          trailData.features
            .filter(f => f.geometry?.type === "Point")
            .map(f => safeStr(f.properties?.type))
            .filter(Boolean)
        )).sort((a,b) => a.localeCompare(b, "he"));

        const sel = $("poiType");
        while (sel.options.length > 1) sel.remove(1);
        for (const t of types) {
          const opt = document.createElement("option");
          opt.value = t; opt.textContent = t;
          sel.appendChild(opt);
        }

        // Init layers (idempotent)
        initLayersOnce();

        // Fit to full trail
        if (wholeBbox) fitBounds(wholeBbox, 60);

        // Wire controls (only once)
        $("poiType").addEventListener("change", applyPoiFilters);
        $("poiSearch").addEventListener("input", applyPoiFilters);

        $("clearFilters").addEventListener("click", () => {
          $("poiType").value = "__all__";
          $("poiSearch").value = "";
          applyPoiFilters();
          showToast("×¡×™× ×•×Ÿ × ×§×•×“×•×ª × ×•×§×”.");
        });

        $("fitAllBtn").addEventListener("click", () => {
          clearSegmentSelection();
          if (wholeBbox) fitBounds(wholeBbox, 60);
        });

        $("locateBtn").addEventListener("click", () => {
          try { geolocate.trigger(); }
          catch { showToast("×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ ××™×§×•×. ×‘×“×•×§ ×”×¨×©××•×ª GPS ×‘×“×¤×“×¤×Ÿ."); }
        });

        $("resetBtn").addEventListener("click", () => {
          clearSegmentSelection();
          $("poiType").value = "__all__";
          $("poiSearch").value = "";
          applyPoiFilters();
          if (wholeBbox) fitBounds(wholeBbox, 60);
          showToast("××•×¤×¡. ×—×–×¨× ×• ×œ××¦×‘ ×”×”×ª×—×œ×ª×™.");
        });

        // Panel collapse
        const panelBody = $("panelBody");
        let collapsed = false;
        $("togglePanel").addEventListener("click", () => {
          collapsed = !collapsed;
          panelBody.style.display = collapsed ? "none" : "block";
        });

        // Apply filters initially
        applyPoiFilters();

        updateSubtitle("××•×›×Ÿ. ×‘×—×¨ ××§×˜×¢ ××• ×¡× ×Ÿ × ×§×•×“×•×ª.");
        setLoading(false);

      } catch (err) {
        console.error(err);
        setLoading(false);

        // Friendly diagnostics
        const msg = String(err?.message || err);
        if (msg.includes("Timeout")) {
          showToast("×”×˜×¢×™× ×” ×œ×•×§×—×ª ×™×•×ª×¨ ××“×™ ×–××Ÿ. ×‘×“×•×§ ×©×™×© token ×ª×§×™×Ÿ ×•×©Ö¾data/trail.geojson × ×’×™×©.", 9000);
          updateSubtitle("×ª×§×œ×” ×‘×˜×¢×™× ×” (Timeout).");
        } else if (msg.includes("GeoJSON HTTP 404") || msg.includes("404")) {
          showToast("×œ× ××¦××ª×™ ××ª data/trail.geojson ×‘×¤×¨×™×¡×”. ×‘×“×•×§ ×©×”×§×•×‘×¥ × ××¦× ×‘×ª×™×§×™×™×” data ×‘×©×•×¨×© ×”××ª×¨.", 9000);
          updateSubtitle("×©×’×™××”: GeoJSON ×œ× × ××¦×.");
        } else if (msg.toLowerCase().includes("access token")) {
          showToast("× ×¨××” ×©×”-token ×©×œ Mapbox ×œ× ×ª×§×™×Ÿ/×—×¡×¨. ×”×“×‘×§ token ×¦×™×‘×•×¨×™ (pk...).", 9000);
          updateSubtitle("×©×’×™××”: Token.");
        } else {
          showToast("×©×’×™××” ×‘×˜×¢×™× ×”. ×¤×ª×— Console ×œ×¤×¨×˜×™×.", 9000);
          updateSubtitle("×©×’×™××” ×‘×˜×¢×™× ×”.");
        }
      }
    }

    // Kick off
    boot();
  </script>
</body>
</html>